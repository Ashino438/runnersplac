<%- include('partials/header', { current:'home', user, req }) %>


<section class="hero">
  <div class="container">
    <h1>みんなで作るランニングシューズレビュー</h1>
    <p>スペックと実走の両面から，あなたに合う一足を見つけよう．フィルタで絞り込んで素早く比較できる．</p>
    <div class="toolbar" style="margin-top:14px">
      <div class="field" style="min-width:260px">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input class="input" id="q" placeholder="シューズ名・ブランドで検索" value="<%= q || '' %>">
      </div>
      <button class="btn" id="openFilters">フィルタ</button>
      <% if (activeFilters && activeFilters.length){ %>
        <span class="badge"><%= activeFilters.length %> 件の条件</span>
      <% } %>
    </div>
  </div>
</section>

<section class="section">
  <div class="container grid" id="shoeGrid">
    <% (shoes || []).forEach(function(s){ %>
      <article class="card" data-slug="<%= s.slug %>"
        onclick="if(event.target.closest('.actions')) return; location.href='/shoes/<%= s.slug %>'">
        <div class="card-header">
          <img class="thumb" src="<%= s.image || '/img/placeholder-shoe.jpg' %>" alt="<%= s.name %>">
          <div style="flex:1">
            <h3><%= s.name %></h3>
            <div class="meta">
              <span><%= s.brand %></span>
              <span>用途：<%= s.purpose ??'—' %></span>
              <span>価格：<%= s.price ? '¥'+s.price.toLocaleString() : '—' %></span>
              <span>重量：<%= s.weight ? s.weight+'g' : '—' %></span>
              <span>ドロップ：<%= (s.drop ?? '—') %>mm</span>
            </div>

            <div class="kpis">
              <div class="kpi"><div class="label">総合</div><div class="val"><%= s.score?.overall ?? '—' %></div></div>
              <div class="kpi"><div class="label">クッション</div><div class="val"><%= s.score?.cushion ?? '—' %></div></div>
              <div class="kpi"><div class="label">安定性</div><div class="val"><%= s.score?.stability ?? '—' %></div></div>
              <div class="kpi"><div class="label">スピード</div><div class="val"><%= s.score?.speed ?? '—' %></div></div>
            </div>

            <div style="margin-top:.4rem">
              <canvas class="mini-radar" width="160" height="160"
                data-name="<%= s.name %>"
                data-cushion="<%= s.score?.cushion ?? '' %>"
                data-stability="<%= s.score?.stability ?? '' %>"
                data-lightness="<%= s.score?.lightness ?? '' %>"
                data-cost="<%= s.score?.cost ?? '' %>"
                data-fit="<%= s.score?.fit ?? '' %>"
                data-design="<%= s.score?.design ?? '' %>"
                data-breathability="<%= s.score?.breathability ?? '' %>"
                data-speed="<%= s.score?.speed ?? '' %>"
                data-grip="<%= s.score?.grip ?? '' %>"
                data-durability="<%= s.score?.durability ?? '' %>">
              </canvas>
            </div>

            <div class="actions">
              <a class="btn brand detail-btn" href="/shoes/<%= s.slug %>">詳細 ▼</a>
              <button class="wish-btn" data-shoe-id="<%= String(s.id) %>">購入候補に入れる</button>
            </div>

          </div>
        </div>
      </article>
    <% }) %>
  </div>
</section>


<!-- フィルタモーダル -->
<div id="filtersModal" style="display:none;position:fixed;inset:0;z-index:60;background:rgba(0,0,0,.55)">
  <div style="margin:60px auto;max-width:820px;background:var(--surface);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:18px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2>フィルタ</h2>
      <button class="btn" id="closeFilters">閉じる</button>
    </div>
    <form method="GET" action="/home2">
      <div class="grid" style="gap:10px">
        <div class="card" style="grid-column:span 12">
          <h3>基本</h3>
          <div class="toolbar" style="margin-top:10px">
            <div class="field"><span class="badge">ブランド</span><input class="input" name="brand" placeholder="ASICS / NIKE / …" value="<%= brand || '' %>"></div>
            <div class="field"><span class="badge">価格上限</span><input class="input" type="number" name="priceMax" placeholder="20000" value="<%= priceMax || '' %>"></div>
            <div class="field"><span class="badge">重量上限</span><input class="input" type="number" name="weightMax" placeholder="260" value="<%= weightMax || '' %>"></div>
          </div>
        </div>
        <div class="card" style="grid-column:span 12">
          <h3>性能（任意）</h3>
          <div class="toolbar" style="margin-top:10px">
            <div class="field"><span class="badge">クッション≥</span><input class="input" type="number" name="cushionMin" min="1" max="5" step="1" value="<%= cushionMin || '' %>"></div>
            <div class="field"><span class="badge">安定性≥</span><input class="input" type="number" name="stabilityMin" min="1" max="5" step="1" value="<%= stabilityMin || '' %>"></div>
            <div class="field"><span class="badge">スピード≥</span><input class="input" type="number" name="speedMin" min="1" max="5" step="1" value="<%= speedMin || '' %>"></div>
          </div>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:.6rem;margin-top:12px">
        <a class="btn" href="/home2">リセット</a>
        <button class="btn brand" type="submit">この条件で絞り込む</button>
      </div>
    </form>
  </div>
</div>




<footer class="footer">
  <div class="container">© <%= new Date().getFullYear() %> Runnersplac．</div>
</footer>

<!-- 必要スクリプト -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script>
  const $ = (q)=>document.querySelector(q);
  $('#openFilters')?.addEventListener('click',()=>{$('#filtersModal').style.display='block'});
  $('#closeFilters')?.addEventListener('click',()=>{$('#filtersModal').style.display='none'});
  $('#q')?.addEventListener('keydown',(e)=>
 { if(e.key==='Enter'){ location.href = '/home2?q=' + encodeURIComponent(e.target.value); } }); 


  // 10軸レーダー
  const miniCharts = document.querySelectorAll('canvas.mini-radar');
  if (miniCharts.length) {
    const labels10 = [
      'クッション性','安定性','軽さ','コスパ','履き心地',
      'デザイン','通気性','スピード性能','グリップ','耐久性'
    ];
    const keys10 = [
      'cushion','stability','lightness','cost','fit',
      'design','breathability','speed','grip','durability'
    ];

    const makeRadar = (cv)=>{
      const ds = cv.dataset;
      const vals = keys10.map(k => {
        const v = ds[k];
        return v !== undefined && v !== '' ? Number(v) : null; // 未入力はnullでスキップ
      });

      new Chart(cv.getContext('2d'), {
        type: 'radar',
        data: {
          labels: labels10,
          datasets: [{
            label: ds.name || 'Score',
            data: vals,
            fill: true,
            backgroundColor: 'rgba(31,111,235,0.20)',
            borderColor: 'rgba(31,111,235,0.85)',
            pointBackgroundColor: 'rgba(31,111,235,1)',
            pointRadius: 2
          }]
        },
        options: {
          responsive: false,
          animation: { duration: 300 },
          scales: {
            r: {
              beginAtZero: true,
              min: 0, max: 5, ticks: { stepSize: 1, display: false },
              grid: { color: 'rgba(255,255,255,0.08)' },
              angleLines: { color: 'rgba(255,255,255,0.08)' },
              pointLabels: { color: getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#9aa7b2', font: { size: 8 } }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          }
        }
      });
      cv.dataset.rendered = '1';
    };

    const io = ('IntersectionObserver' in window) ? new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if(e.isIntersecting){
          const cv = e.target;
          if(!cv.dataset.rendered) makeRadar(cv);
          io.unobserve(cv);
        }
      });
    }, { rootMargin: '100px' }) : null;

    miniCharts.forEach(cv=>{
      if(io) io.observe(cv); else makeRadar(cv);
    });
  }


  document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.wish-btn');
  if (!btn) return;

  const id = btn.dataset.shoeId; // ← 'id' に統一
  if (!id) { alert('シューズIDが取れない…'); return; }

  const r = await fetch('/api/wishlist', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ id }) // ← サーバは id を見る
  });
  const j = await r.json().catch(()=> ({}));

  if (!r.ok || !j.ok) {
    alert(j.msg || '追加に失敗したよ');
    return;
  }
  btn.textContent = '追加済み';
});



</script>

<style>
  .mini-radar{
    display:block;
    margin-top:4px;
    border:1px solid var(--border);
    border-radius:12px;
    background:rgba(255,255,255,.02)
  }
  .container.grid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:16px;
  }
  .container.grid .card{ grid-column:auto; }
  @media (max-width:768px){
    .container.grid{ grid-template-columns:1fr; }
  }
  .wish-btn {
  background-color: #ff6b35; /* 明るめオレンジ */
  color: #fff;
  border: none;
  border-radius: 24px; /* ラウンド感 */
  padding: 8px 16px;
  font-size: 0.9rem;
  font-weight: bold;
  cursor: pointer;
  transition: background-color .2s ease, transform .1s ease;
}

.wish-btn:hover {
  background-color: #e85a2a; /* 濃いオレンジに */
  transform: translateY(-1px);
}

.wish-btn:active {
  background-color: #d94f20;
  transform: translateY(0);
}

</style>

